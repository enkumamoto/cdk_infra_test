# üì¶ Project: AWS Infrastructure with CDK, ECS, RDS, Puppet and FastAPI

This project provisions a complete infrastructure on AWS using AWS CDK (Python), integrating:

- VPC with public and private subnets
- EC2 Bastion Host with Puppet
- RDS Aurora PostgreSQL Serverless v2
- ECS Fargate
- ECR
- Application Load Balancer
- FastAPI Application
- Client-to-Site VPN
- CI/CD Pipeline with GitHub Actions

## üó∫Ô∏è Architecture

```mermaid
flowchart TB
    User[User / Internet] --> ALB[Application Load Balancer :80]
    DevVPN[VPN User] --> VPN[Client VPN Endpoint]

    subgraph AWS
        subgraph VPC
            subgraph PublicSubnet
                ALB
            end

            subgraph PrivateSubnet
                ECS[ECS Fargate Service]
                Bastion[Bastion Host EC2]
                RDS[(Aurora PostgreSQL)]
            end
        end

        S3[S3 Puppet Bucket]
        ECR[ECR Repository]
        Secrets[Secrets Manager]
    end

    VPN --> Bastion

    ALB --> ECS
    ECS --> RDS

    ECS --> Secrets
    Bastion --> RDS
    Bastion --> S3

    ECS --> ECR
```

## üß± Infrastructure Components

### ü™£ S3 (Puppet Bucket)

Bucket responsible for storing Puppet manifests and modules.

**Function:**

- Centralize configuration files
- Allow Bastion Host to automatically sync manifests

### üåê VPC
- 2 AZs
- Subnets:
  - Public (ALB)
  - Private with NAT (ECS, RDS, Bastion)

### üîê VPN (Client-to-Site)

AWS-managed VPN for secure access to the private environment.

**Functions:**

- Allows access to Bastion Host without public IP
- Private database access for administration
- Certificate-based authentication
  
**Flow:**

- User connects via OpenVPN Client
- Traffic enters Client VPN Endpoint
- Forwarded to private subnets
- Access to Bastion Host and RDS

```mermaid
sequenceDiagram
    participant User as VPN User
    participant VPN as AWS Client VPN
    participant Bastion as Bastion Host
    participant RDS as Aurora DB

    User->>VPN: TLS Connection
    VPN->>Bastion: Private Access
    VPN->>RDS: PostgreSQL Access
    Bastion->>RDS: Query
```

### üñ•Ô∏è Bastion Host (EC2)

Private EC2 instance used for:

- Administrative access via AWS SSM
- Puppet execution
- VPN access

**Functions:**

- Installs Puppet
- Syncs files from S3
- Automatically applies manifests on boot

**Executed snippet:**

```
aws s3 sync s3://<bucket>/puppet /opt/puppet
puppet apply puppet/manifests/site.pp
```

### üóÑÔ∏è RDS Aurora PostgreSQL Serverless v2

Relational database:

- Engine: Aurora PostgreSQL 14

- Serverless (auto scaling)

- Access allowed only:
    - Bastion Host
    - ECS
    - VPN 

- Credentials:
    - Automatically generated by Secrets Manager

### üê≥ ECR (Elastic Container Registry)

Repository for storing the FastAPI application Docker image.

### üöÄ ECS Fargate

Runs the FastAPI application as a container.

**Configuration:**

- Task Definition
- Environment variables:
  - DB_NAME
  - DB_HOST

- Secrets:
  - DB_USER
  - DB_PASSWORD

### ‚öñÔ∏è Application Load Balancer (ALB)

- Port: 80
- Routes requests to ECS
- Health check: `/health`

## üß© FastAPI Application

**Location:** - `app_fastapi/`

**Function:**

- REST API
- Connected to PostgreSQL database
- Exposed via ALB

**Endpoint example:**

- GET `/health`

## üßô Puppet

**Structure:**

```bash
puppet/
‚îú‚îÄ‚îÄ manifests
‚îÇ   ‚îî‚îÄ‚îÄ site.pp
‚îî‚îÄ‚îÄ modules
    ‚îú‚îÄ‚îÄ users
    ‚îî‚îÄ‚îÄ phpmyadmin
```

**Functions:**

- User creation
- Package installation
- Automatic instance configuration
- Automatically applied on Bastion Host.

## ‚öôÔ∏è GitHub Actions (Workflow)

Pipeline responsible for:

- Authenticating to AWS via OIDC
- Installing dependencies
- Executing: `cdk deploy --require-approval never`

**Triggers:**

- Push to main branch
- Manual (workflow_dispatch)

## ‚ñ∂Ô∏è How to Execute

1. **Install dependencies**

```bash
pip install -r requirements.txt
npm install -g aws-cdk
CDK Bootstrap
```
2. **CDK Bootstrap**
```bash
cdk bootstrap
Deploy infrastructure
```
3. **Deploy**
```bash
cdk synth
cdk deploy
```

##üì§ Outputs

At the end of deployment:

- Public application URL
- Bastion instance ID
- Database endpoint
- Secret ARN
- Puppet bucket name

## üîê Best Practices Implemented
‚úîÔ∏è Private subnets
‚úîÔ∏è No public IP on ECS
‚úîÔ∏è Credentials in Secrets Manager
‚úîÔ∏è Infrastructure as code (CDK)
‚úîÔ∏è Automation with Puppet
‚úîÔ∏è CI/CD with GitHub Actions
‚úîÔ∏è Secure access via VPN

## üß† Technologies

- AWS CDK (Python)
- FastAPI
- ECS Fargate
- Aurora PostgreSQL
- Puppet
- Docker
- GitHub Actions
- OpenVPN / AWS Client VPN

## üìå Notes

This project is educational and demonstrates:

- Infrastructure + App integration
- Automated infrastructure
- Automatic configuration via Puppet
- Continuous deployment with pipeline
- Secure private access via VPN

## üîÅ Boot Flow

```mermaid
sequenceDiagram
    participant EC2 as Bastion Host
    participant S3 as S3 Puppet Bucket
    participant Puppet as Puppet
    participant RDS as Aurora DB

    EC2->>S3: aws s3 sync /puppet
    EC2->>Puppet: puppet apply site.pp
    Puppet->>EC2: Configure system
    EC2->>RDS: Test connectivity
```

## üöÄ Application Flow (Request)

```mermaid
sequenceDiagram
    participant User
    participant ALB
    participant ECS
    participant RDS

    User->>ALB: HTTP Request
    ALB->>ECS: Forward
    ECS->>RDS: Query
    RDS->>ECS: Response
    ECS->>ALB: HTTP 200
    ALB->>User: JSON Response
```

## ‚öôÔ∏è Pipeline Flow (GitHub Actions)
```mermaid
flowchart LR
    Dev["Dev pushes to main"] --> GitHub["GitHub Repo"]

    GitHub --> Actions["GitHub Actions Workflow"]

    Actions --> Checkout["Checkout code"]
    Checkout --> Auth["AWS Auth (OIDC)"]
    Auth --> Deps["Install dependencies"]
    Deps --> CDK["cdk deploy"]

    CDK --> CloudFormation["CloudFormation Stack"]
    CloudFormation --> Infra["Provisioned/Updated Infra"]
```

##üß© Application Deployment Flow
```mermaid
flowchart LR
    Dev --> Build[Build Docker image]
    Build --> Push[ECR]
    Push --> ECS[ECS Fargate]

    ECS -->|New task| ALB
    ALB --> User
```
